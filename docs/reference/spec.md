# 语言规范

凹语言是通用型的编程语言，它是强类型化的语言，具有自动内存管理机制，主要面向 WebAssembly 生态设计。程序由包组成以此来提供简单灵活的依赖管理功能。目前实现通过编译链接流程，将凹语言源代生成独立的 WebAssembly 模块。凹语言语法设计的紧凑，便于解析和 IDE 等自动化工具分析。

## 1 EBNF 记法

凹语言语法使用扩展的巴克斯-诺尔范式（EBNF）定义：

```
生成式 = 生成式名 "=" [ 表达式 ] "." .
表达式 = 选择项 { "|" 选择项 } .
选择项 = 条目 { 条目 } .
条目   = 生成式名 | 标记 [ "…" 标记 ] | 分组 | 可选项 | 重复项 .
分组   = "(" 表达式 ")" .
可选项 = "[" 表达式 "]" .
重复项 = "{" 表达式 "}" .
```

其中生成式由表达式构造，表达式通过术和以下操作符构造，自上而下优先级递增（低到高）：

```
|   选择
()  分组
[]  可选（0 或 1 次）
{}  重复（0 到 n 次）
```

用小写生成式名用于标识词法标记。使用非最终（Non-terminals）词法标记使用驼峰记法（CamelCase）。而位于双引号 "" 内的即为词法标记。形式 a … b 表示把从 a 到 b 的字符集作为选择项。横向省略号 … 也在本文档中非正式地表示各种列举或简略的代码片断。单个字符 …（不同于三个字符 ...）并非凹语言本身的标记。

## 2 源文件表示

为了更好支持中文和其他语言地区的编程，凹语言源码为采用 UTF-8 编码的 Unicode 文本表示。每个码点都是不同的，例如，大写与小写的字母就是不同的字符。同时为了兼容 C 语言字符串的习惯，编译器会阻止字符 NUL（U+0000）出现在源码文本中。此外，如果源文件开头有 BOM 头部，则编译器应该忽略它。为了遵循流行编程语言的习惯，下划线字符被作为字母对待。

## 3 词法元素

### 3.1 注释

凹语言默认采用行注释，以 `#` 开头的表示行注释。注释不能从字符或字符串字面中开始，也不能在其它注释中。行注释可以视做一个换行符。

### 3.2 记号类型

构成凹语言的记号类型有关键字、标识符、面值常量、运算符和分隔符组成，其中空白字符可用于分隔关键字和标识符，分号用于分隔相邻的语句。为了简化用户输入，一些上下文的换行符和文件末尾会自动插入分号。一个凹语言程序在词法解析阶段会被转化为有效的记号序列，便于后续的语法解析工作。

### 3.3 分号

凹语言正式语法使用分号 ";" 作为一些生成式的终止符，使用以下两条规则来省略大多数分号：首先当输入被分解成标记时，若该行的最后一个标记为标识符、字面值、break/continue/return 关键字、`++`/`--`/`)`/`]`/`}`运算符 之一时，那么分号就会在该标记之后立即自动插入；此外为了允许复合语句占据单行，闭合的 `)` 或 `}` 之前的分号可以省略。

### 3.4 标识符

标识符被用来命名函数、变量、类型等程序实体。一个标识符由一个或多个字母和数字组成。标识符的第一个字符必须是字母。

```
标识符 = 字母 { 字母 | Unicode数字 } .

凹
中国
a
_x9
下划线或小写英文字母是未导出的私有标识符
```

有些标识符是预声明的，比如 `iota`/`true`/`false`/`print`/`println`/`this` 等。

### 3.5 关键字

凹语言目前有19个关键字：

```
break     defer  import     struct
case      else   interface  switch
const     for    map        type
continue  fn     range      var
default   if     return
```

关键字是语法的组成元素，不能用于标识符。

### 3.6 运算符

以下是凹语言的运算符和与标点：

```
+    &     +=    &=     &&    ==    !=    (    )
-    |     -=    |=     ||    <     <=    [    ]
*    ^     *=    ^=     <-    >     >=    {    }
/    <<    /=    <<=    ++    =     :=    ,    ;
%    >>    %=    >>=    --    !     ...   .    :
     &^          &^=                      =>
```

运算符用于组成表达式，标点用于组成或分隔语句。

### 3.7 字面值常量

字面值是在凹语言代码中明确写出的值，有布尔值、整数、浮点数、字符串、字符几种类型。其中布尔值有`true`、`false`；整数字面值有二进制、八进制、十进制、十六进制几种表示格式；浮点数字面值有小数、科学计数法和十六进制浮点数几种形式；字符串有普通字符串和支持多行的原生字符串几种形式；字符则是有单引号包含表示单个字符。所有的字面值都是无类型的常量。

普通字符串和字符面值支持的转义符号：

```
\a   U+0007 警报或铃声
\b   U+0008 退格
\f   U+000C 换页
\n   U+000A 换行
\r   U+000D 回车
\t   U+0009 横向制表符
\v   U+000b 纵向制表符
\\   U+005c 反斜杠
\'   U+0027 单引号（仅在符文字面中有效）
\"   U+0022 双引号（仅在字符串字面中有效）
```

以下是常见的字面值常量：

```
# 布尔字面值
true
false

# 整数
42
4_2
0600
0_600
-42

# 浮点数
0.
72.40
3.1415926
1_5.         # == 15.0
0.15e+0_2    # == 15.0
0x1p-2       # == 0.25
0x2.p10      # == 2048.0

# 字符串
"凹语言"                                 # UTF-8 输入的文本
`凹语言`                                 # UTF-8 输入的原始字面文本
"\u65e5\u672c\u8a9e"                    # 显式的 Unicode 码点
"\U000065e5\U0000672c\U00008a9e"        # 显式的 Unicode 码点
"\xe6\x97\xa5\xe6\x9c\xac\xe8\xaa\x9e"  # 显式的 UTF-8 字节

# 字符
'凹'
'a'
'ä'
'\t'
'\000'
'\007'
'\xff'
'\u12e4'
'\U00101234'
```

如果源码将两个码点表示为一个字符，例如包含着重号和字母的结合形式，凹语言会当作两个字面处理（因此不能作为字符面值）。

## 4 常量和变量

## 5 类型

## 6 函数和方法

## 7 代码块

## 8 表达式

## 9 语句

## 10 包结构

## 11 初始化和执行顺序


